<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Atlas project - part two" /><meta property="og:locale" content="en" /><meta name="description" content="OK, so we have our docker image, and we are storing it in the Docker repository. Now what. Well we want to create some cloud infrastructure, so we can deploy our game, but we will be using Terraform to code up our infrastructure." /><meta property="og:description" content="OK, so we have our docker image, and we are storing it in the Docker repository. Now what. Well we want to create some cloud infrastructure, so we can deploy our game, but we will be using Terraform to code up our infrastructure." /><link rel="canonical" href="/posts/atlas-project-part-two/" /><meta property="og:url" content="/posts/atlas-project-part-two/" /><meta property="og:site_name" content="Sam’s 2nd brain" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-04-24T14:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Atlas project - part two" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-04-25T13:47:09+00:00","datePublished":"2023-04-24T14:00:00+00:00","description":"OK, so we have our docker image, and we are storing it in the Docker repository. Now what. Well we want to create some cloud infrastructure, so we can deploy our game, but we will be using Terraform to code up our infrastructure.","headline":"Atlas project - part two","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/atlas-project-part-two/"},"url":"/posts/atlas-project-part-two/"}</script><title>Atlas project - part two | Sam's 2nd brain</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Sam's 2nd brain"><meta name="application-name" content="Sam's 2nd brain"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/54186142?s=400&u=fabf11da8c31b3afad7d8fbc76732b43734a685c&v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Sam's 2nd brain</a></div><div class="site-subtitle font-italic">brain of brain</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/Harrison-S1" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Atlas project - part two</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Atlas project - part two</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1682344800" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Apr 24, 2023 </em> </span> <span> Updated <em class="" data-ts="1682430429" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Apr 25, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/username">Sam</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1384 words"> <em>7 min</em> read</span></div></div></div><div class="post-content"><p>OK, so we have our docker image, and we are storing it in the Docker repository. Now what. Well we want to create some cloud infrastructure, so we can deploy our game, but we will be using Terraform to code up our infrastructure.</p><blockquote><p>Note, for this, I’m going to use the cloud playground from my subscription to A Cloud Guru. You can use this project on with the AWS free tier account, so if you need to go and sign up.</p></blockquote><h3 id="terraform"><span class="mr-2">Terraform</span><a href="#terraform" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Let’s create a new folder, name it whatever and create your <code class="language-plaintext highlighter-rouge">main.tf</code> file with the following.</p><blockquote><p>In here we are just defining around AWS instance.</p></blockquote><div class="language-hcl highlighter-rouge"><div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_instance"</span> <span class="s2">"dev_node"</span> <span class="p">{</span>
  <span class="nx">instance_type</span>          <span class="p">=</span> <span class="s2">"t2.micro"</span>
  <span class="nx">ami</span>                    <span class="p">=</span> <span class="nx">data</span><span class="err">.</span><span class="nx">aws_ami</span><span class="err">.</span><span class="nx">server_ami</span><span class="err">.</span><span class="nx">id</span>
  <span class="nx">vpc_security_group_ids</span> <span class="p">=</span> <span class="p">[</span><span class="nx">aws_security_group</span><span class="err">.</span><span class="nx">main_aws_sg</span><span class="err">.</span><span class="nx">id</span><span class="p">]</span>
  <span class="nx">iam_instance_profile</span>   <span class="p">=</span> <span class="nx">aws_iam_instance_profile</span><span class="err">.</span><span class="nx">dev_profile</span><span class="err">.</span><span class="nx">name</span>
  <span class="nx">subnet_id</span>              <span class="p">=</span> <span class="nx">aws_subnet</span><span class="err">.</span><span class="nx">main_public_subnet</span><span class="err">.</span><span class="nx">id</span>
  <span class="nx">user_data</span>              <span class="p">=</span> <span class="nx">file</span><span class="err">(</span><span class="s2">"userdata.tpl"</span><span class="err">)</span>

  <span class="nx">root_block_device</span> <span class="p">{</span>
    <span class="nx">volume_size</span> <span class="p">=</span> <span class="mi">10</span>
  <span class="p">}</span>

  <span class="nx">tags</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="p">=</span> <span class="s2">"dev-node"</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>From here on out, just create the file name and add the code.</p><h4 id="vpctf"><span class="mr-2">vpc.tf</span><a href="#vpctf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p>Here we are defining everything we need for our network in AWS.</p></blockquote><div class="language-hcl highlighter-rouge"><div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_vpc"</span> <span class="s2">"mainvpc"</span> <span class="p">{</span>
  <span class="nx">cidr_block</span>           <span class="p">=</span> <span class="s2">"10.123.0.0/16"</span>
  <span class="nx">enable_dns_hostnames</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">enable_dns_support</span>   <span class="p">=</span> <span class="kc">true</span>

  <span class="nx">tags</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="p">=</span> <span class="s2">"dev"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_subnet"</span> <span class="s2">"main_public_subnet"</span> <span class="p">{</span>
  <span class="nx">vpc_id</span>                  <span class="p">=</span> <span class="nx">aws_vpc</span><span class="err">.</span><span class="nx">mainvpc</span><span class="err">.</span><span class="nx">id</span>
  <span class="nx">cidr_block</span>              <span class="p">=</span> <span class="s2">"10.123.1.0/24"</span>
  <span class="nx">map_public_ip_on_launch</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">availability_zone</span>       <span class="p">=</span> <span class="s2">"us-east-1a"</span>

  <span class="nx">tags</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="p">=</span> <span class="s2">"dev-public"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_internet_gateway"</span> <span class="s2">"main_internet_gateway"</span> <span class="p">{</span>
  <span class="nx">vpc_id</span> <span class="p">=</span> <span class="nx">aws_vpc</span><span class="err">.</span><span class="nx">mainvpc</span><span class="err">.</span><span class="nx">id</span>

  <span class="nx">tags</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="p">=</span> <span class="s2">"dev-igw"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_route_table"</span> <span class="s2">"main_public_rt"</span> <span class="p">{</span>
  <span class="nx">vpc_id</span> <span class="p">=</span> <span class="nx">aws_vpc</span><span class="err">.</span><span class="nx">mainvpc</span><span class="err">.</span><span class="nx">id</span>

  <span class="nx">tags</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="p">=</span> <span class="s2">"dev_public_rt"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_route"</span> <span class="s2">"default_route"</span> <span class="p">{</span>
  <span class="nx">route_table_id</span>         <span class="p">=</span> <span class="nx">aws_route_table</span><span class="err">.</span><span class="nx">main_public_rt</span><span class="err">.</span><span class="nx">id</span>
  <span class="nx">destination_cidr_block</span> <span class="p">=</span> <span class="s2">"0.0.0.0/0"</span>
  <span class="nx">gateway_id</span>             <span class="p">=</span> <span class="nx">aws_internet_gateway</span><span class="err">.</span><span class="nx">main_internet_gateway</span><span class="err">.</span><span class="nx">id</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_route_table_association"</span> <span class="s2">"main_public_assoc"</span> <span class="p">{</span>
  <span class="nx">subnet_id</span>      <span class="p">=</span> <span class="nx">aws_subnet</span><span class="err">.</span><span class="nx">main_public_subnet</span><span class="err">.</span><span class="nx">id</span>
  <span class="nx">route_table_id</span> <span class="p">=</span> <span class="nx">aws_route_table</span><span class="err">.</span><span class="nx">main_public_rt</span><span class="err">.</span><span class="nx">id</span>
<span class="p">}</span>
</pre></table></code></div></div><h4 id="variabletf"><span class="mr-2">variable.tf</span><a href="#variabletf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p>Here, we define any variables being used. In this case, the host OS</p></blockquote><div class="language-hcl highlighter-rouge"><div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nx">variable</span> <span class="s2">"host_os"</span> <span class="p">{</span>
  <span class="nx">type</span>        <span class="p">=</span> <span class="nx">string</span>
  <span class="nx">default</span>     <span class="p">=</span> <span class="s2">"linux"</span>
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"default os being used to deploy"</span>
<span class="p">}</span>
</pre></table></code></div></div><h4 id="sgtf"><span class="mr-2">sg.tf</span><a href="#sgtf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p>Here we are creating the security group that will be attacked to our AWS instance. For the sack of the project, it has been left open to all traffic. But we will look at securing it later on.</p></blockquote><div class="language-hcl highlighter-rouge"><div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_security_group"</span> <span class="s2">"main_aws_sg"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="p">=</span> <span class="s2">"dev_sg"</span>
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"dev security group"</span>
  <span class="nx">vpc_id</span>      <span class="p">=</span> <span class="nx">aws_vpc</span><span class="err">.</span><span class="nx">mainvpc</span><span class="err">.</span><span class="nx">id</span>

  <span class="nx">ingress</span> <span class="p">{</span>
    <span class="nx">from_port</span>   <span class="p">=</span> <span class="mi">0</span>
    <span class="nx">to_port</span>     <span class="p">=</span> <span class="mi">0</span>
    <span class="nx">protocol</span>    <span class="p">=</span> <span class="s2">"-1"</span>
    <span class="nx">cidr_blocks</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="nx">egress</span> <span class="p">{</span>
    <span class="nx">from_port</span>   <span class="p">=</span> <span class="mi">0</span>
    <span class="nx">to_port</span>     <span class="p">=</span> <span class="mi">0</span>
    <span class="nx">protocol</span>    <span class="p">=</span> <span class="s2">"-1"</span>
    <span class="nx">cidr_blocks</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h4 id="iamtf"><span class="mr-2">iam.tf</span><a href="#iamtf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p>Here we are creating the IAM role of the instance. <code class="language-plaintext highlighter-rouge">Note that this isnt required for the current interation, but if you where adding a S3 bucket, this will give the ec2 instance access and well as access to CloudWatch</code></p></blockquote><div class="language-hcl highlighter-rouge"><div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre><td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_iam_role"</span> <span class="s2">"EC2_dev_role"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="p">=</span> <span class="s2">"EC2_dev_role"</span>

  <span class="nx">assume_role_policy</span> <span class="p">=</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Action": "sts:AssumeRole",
      "Principal": {
        "Service": "ec2.amazonaws.com"
      },
      "Effect": "Allow",
      "Sid": ""
    }
  ]
}
</span><span class="no">EOF

</span>  <span class="nx">tags</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">tag</span><span class="err">-</span><span class="nx">key</span> <span class="p">=</span> <span class="s2">"Cloudwatch"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_iam_instance_profile"</span> <span class="s2">"dev_profile"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="p">=</span> <span class="s2">"dev_profile"</span>
  <span class="nx">role</span> <span class="p">=</span> <span class="nx">aws_iam_role</span><span class="err">.</span><span class="nx">EC2_dev_role</span><span class="err">.</span><span class="nx">name</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_iam_role_policy"</span> <span class="s2">"s3-dev"</span> <span class="p">{</span>
  <span class="nx">name</span>   <span class="p">=</span> <span class="s2">"s3-dev"</span>
  <span class="nx">role</span>   <span class="p">=</span> <span class="nx">aws_iam_role</span><span class="err">.</span><span class="nx">EC2_dev_role</span><span class="err">.</span><span class="nx">id</span>
  <span class="nx">policy</span> <span class="p">=</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "s3:*",
                "s3-object-lambda:*"
            ],
            "Resource": "*"
        }
    ]
}
</span><span class="no">EOF
</span><span class="p">}</span>
</pre></table></code></div></div><h4 id="datasourcetf"><span class="mr-2">datasource.tf</span><a href="#datasourcetf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p>Here we are declaring the data source of our AMI image.</p></blockquote><div class="language-hcl highlighter-rouge"><div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="nx">data</span> <span class="s2">"aws_ami"</span> <span class="s2">"server_ami"</span> <span class="p">{</span>
  <span class="nx">most_recent</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">owners</span>      <span class="p">=</span> <span class="p">[</span><span class="s2">"099720109477"</span><span class="p">]</span>

  <span class="nx">filter</span> <span class="p">{</span>
    <span class="nx">name</span>   <span class="p">=</span> <span class="s2">"name"</span>
    <span class="nx">values</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*"</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h4 id="outputstf"><span class="mr-2">outputs.tf</span><a href="#outputstf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p>Sometimes we need some information about our instance after it has been created, such as its IP or instance ID.</p></blockquote><div class="language-hcl highlighter-rouge"><div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="nx">output</span> <span class="s2">"dev_ip"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"Output the public IP of the dev node instance"</span>
  <span class="nx">value</span>       <span class="p">=</span> <span class="nx">aws_instance</span><span class="err">.</span><span class="nx">dev_node</span><span class="err">.</span><span class="nx">public_ip</span>
<span class="p">}</span>

<span class="nx">output</span> <span class="s2">"instance_id"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"ID of the EC2 instance"</span>
  <span class="nx">value</span>       <span class="p">=</span> <span class="nx">aws_instance</span><span class="err">.</span><span class="nx">dev_node</span><span class="err">.</span><span class="nx">id</span>
<span class="p">}</span>
</pre></table></code></div></div><h4 id="userdatatpl"><span class="mr-2">userdata.tpl</span><a href="#userdatatpl" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p>If you have created your own docker reg, you can the script to pull that image inseed.</p></blockquote><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
<span class="nb">sudo </span>apt-get update <span class="nt">-y</span> <span class="o">&amp;&amp;</span> 
<span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> apt-transport-https ca-certificates curl gnupg-agent software-properties-common
wget https://s3.amazonaws.com/amazoncloudwatch-agent/ubuntu/amd64/latest/amazon-cloudwatch-agent.deb
<span class="nb">sudo </span>dpkg <span class="nt">-i</span> amazon-cloudwatch-agent.deb
<span class="nb">sudo </span>curl <span class="nt">-o</span> /opt/aws/amazon-cloudwatch-agent/amazon-cloudwatch-agent.json https://raw.githubusercontent.com/Harrison-S1/terraform/master/cloudwatch-config.json
<span class="nb">sudo</span> /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl <span class="nt">-a</span> fetch-config <span class="nt">-m</span> ec2 <span class="nt">-s</span> <span class="nt">-c</span> file:/opt/aws/amazon-cloudwatch-agent/amazon-cloudwatch-agent.json 
curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg | <span class="nb">sudo </span>gpg <span class="nt">--dearmor</span> <span class="nt">-o</span> /etc/apt/keyrings/docker.gpg
<span class="nb">echo</span> <span class="se">\</span>
  <span class="s2">"deb [arch=</span><span class="si">$(</span>dpkg <span class="nt">--print-architecture</span><span class="si">)</span><span class="s2"> signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu </span><span class="se">\</span><span class="s2">
  </span><span class="si">$(</span>lsb_release <span class="nt">-cs</span><span class="si">)</span><span class="s2"> stable"</span> | <span class="nb">sudo tee</span> /etc/apt/sources.list.d/docker.list <span class="o">&gt;</span> /dev/null
<span class="nb">sudo </span>apt-get update <span class="nt">-y</span> <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> docker-ce docker-ce-cli containerd.io docker-compose-plugin
<span class="nb">sudo </span>apt <span class="nb">install </span>unzip <span class="nt">-y</span>
curl <span class="s2">"https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"</span> <span class="nt">-o</span> <span class="s2">"/home/ubuntu/awscliv2.zip"</span>
<span class="nb">sudo </span>usermod <span class="nt">-aG</span> docker ubuntu <span class="c"># &amp;&amp; sudo reboot now</span>
<span class="nb">sudo </span>docker pull harrisons1/2048
<span class="nb">sudo </span>docker run <span class="nt">--name</span> 2048 <span class="nt">-p</span> 80:80 <span class="nt">-d</span> harrisons1/2048
</pre></table></code></div></div><h4 id="providerstf"><span class="mr-2">providers.tf</span><a href="#providerstf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p>OK, so we will need to set up Terraform Cloud to store the state file for this project. Make sure you put your organization and workspaces you have set up in Terraform Cloud into this file.</p></blockquote><div class="language-hcl highlighter-rouge"><div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="nx">terraform</span> <span class="p">{</span>
  <span class="nx">required_providers</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="p">=</span> <span class="p">{</span>
      <span class="nx">source</span> <span class="p">=</span> <span class="s2">"hashicorp/aws"</span>
    <span class="p">}</span>
    <span class="nx">random</span> <span class="p">=</span> <span class="p">{</span>
      <span class="nx">source</span>  <span class="p">=</span> <span class="s2">"hashicorp/random"</span>
      <span class="nx">version</span> <span class="p">=</span> <span class="s2">"3.0.1"</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">required_version</span> <span class="p">=</span> <span class="s2">"~&gt; 1.0"</span>

  <span class="nx">backend</span> <span class="s2">"remote"</span> <span class="p">{</span>
    <span class="nx">organization</span> <span class="p">=</span> <span class="s2">"CHANGEME"</span>

    <span class="nx">workspaces</span> <span class="p">{</span>
      <span class="nx">name</span> <span class="p">=</span> <span class="s2">"CHANGEME"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">provider</span> <span class="s2">"aws"</span> <span class="p">{</span>
  <span class="nx">region</span> <span class="p">=</span> <span class="s2">"us-east-1"</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="setting-up-your-aws-account"><span class="mr-2">Setting up your AWS account</span><a href="#setting-up-your-aws-account" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>You will need to create a user in AWS to deploy this.</p><ul><li>Log into your AWS account.<li>Navigate to IAM and select Users on the left-hand menu<li>Select “Add users”<li>Create the username<li>Select “Access key - Programmatic access” and click next<li>Select “Attach existing policies directly” and use the “AdministratorAccess” policy<blockquote><p>Don’t do this for productions</p></blockquote><li>Tags are optional, so just click next, then create user</ul><p>Now on the next page you need to add the details from user, access key ID and Secret access key to the AWS credentials file.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>~/.aws/credentials
</pre></table></code></div></div><h4 id="for-example"><span class="mr-2">For example</span><a href="#for-example" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="o">[</span>terraformuser]
<span class="c"># This key identifies your AWS account.</span>
aws_access_key_id <span class="o">=</span> QKIAUDRQURVLS2JCIV4
<span class="c"># Treat this secret key like a password. Never share it or store it in source</span>
<span class="c"># control. If your secret key is ever disclosed, immediately use IAM to delete</span>
<span class="c"># the key pair and create a new one.</span>
aws_secret_access_key <span class="o">=</span> nBhpjpTCyerter3sdf0l3QZ7zxV78ptCF
</pre></table></code></div></div><h2 id="setting-up-your-terraform-cloud"><span class="mr-2">Setting up your Terraform Cloud</span><a href="#setting-up-your-terraform-cloud" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><blockquote><p>Here, I’m assuming you already have an AWS account set up.</p></blockquote><blockquote><p>This is part of the backend that is defined in <code class="language-plaintext highlighter-rouge">providers.tf</code>. You will need to go back to the <code class="language-plaintext highlighter-rouge">providers.tf</code> file and change the <code class="language-plaintext highlighter-rouge">organization</code> and <code class="language-plaintext highlighter-rouge">workspaces</code> name.</p></blockquote><p>In your Terraform Cloud, create a new workspace</p><ul><li>Select <code class="language-plaintext highlighter-rouge">API-driven workflow</code><li>Name the workspace and select the project (default is fine)<li>Click on <code class="language-plaintext highlighter-rouge">Create workspace</code><li>In the left-hand menu select <code class="language-plaintext highlighter-rouge">Variables</code><li>Click <code class="language-plaintext highlighter-rouge">Add variable</code><li>Add the <code class="language-plaintext highlighter-rouge">AWS_ACCESS_KEY_ID</code> key, mark it as a <code class="language-plaintext highlighter-rouge">Environment variable</code> and also mark it as <code class="language-plaintext highlighter-rouge">Sensitive</code><li>Do the same for the <code class="language-plaintext highlighter-rouge">AWS_SECRET_ACCESS_KEY</code> variable<li>Now lets create our <code class="language-plaintext highlighter-rouge">TF_API_TOKEN</code> for GitHub Actions.<li>Click on your profile picture at the top left and select <code class="language-plaintext highlighter-rouge">User Settings</code><li>On the left-hand menu select Tokens and click on <code class="language-plaintext highlighter-rouge">Create an API token</code><li>Name it whatever you want, and copy the token to a notepad</ul><p>Now, in your terminal, run <code class="language-plaintext highlighter-rouge">terraform init</code>. Then <code class="language-plaintext highlighter-rouge">terraform fmt</code> to check the format. Once it is happy, you can run a <code class="language-plaintext highlighter-rouge">terraform plan</code>. Check you are happy with the output of the plan, then you can apply it with <code class="language-plaintext highlighter-rouge">terraform apply</code> Congratulations you now have a running game of 2048 in docker on an ec2 instance, with the support of AWS infrastructure, build with Terraform.</p><p>In part 3 we’ll look at setting up some CI with GitHub actions.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/aws/'>aws</a>, <a href='/categories/howto-s/'>howto's</a>, <a href='/categories/linux/'>linux</a>, <a href='/categories/cloud/'>cloud</a>, <a href='/categories/terraform/'>terraform</a>, <a href='/categories/docker/'>docker</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/aws/" class="post-tag no-text-decoration" >aws</a> <a href="/tags/linux/" class="post-tag no-text-decoration" >linux</a> <a href="/tags/howto-s/" class="post-tag no-text-decoration" >howto's</a> <a href="/tags/sysops/" class="post-tag no-text-decoration" >sysops</a> <a href="/tags/cloud/" class="post-tag no-text-decoration" >cloud</a> <a href="/tags/terraform/" class="post-tag no-text-decoration" >terraform</a> <a href="/tags/docker/" class="post-tag no-text-decoration" >docker</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Atlas+project+-+part+two+-+Sam%27s+2nd+brain&url=%2Fposts%2Fatlas-project-part-two%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Atlas+project+-+part+two+-+Sam%27s+2nd+brain&u=%2Fposts%2Fatlas-project-part-two%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fatlas-project-part-two%2F&text=Atlas+project+-+part+two+-+Sam%27s+2nd+brain" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=%2Fposts%2Fatlas-project-part-two%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/atlas-project-part-two/">Atlas project - part two</a><li><a href="/posts/atlas-project-part-one/">Atlas Project - part one</a><li><a href="/posts/aws-storage-gateway/">Creating a Storage Gateway in AWS</a><li><a href="/posts/Expanding-EBS-root-volume/">Expanding EBS root volume</a><li><a href="/posts/CloudWatch-Monitor-EC2-Linux-services-and-set-alarms/">CloudWatch Monitor EC2 Linux services and set alarms</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/howto-s/">howto's</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/sysops/">sysops</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/cloud/">cloud</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/security/">security</a> <a class="post-tag" href="/tags/ansible/">ansible</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/terraform/">terraform</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/aws-storage-gateway/"><div class="card-body"> <em class="small" data-ts="1671285600" data-df="ll" > Dec 17, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Creating a Storage Gateway in AWS</h3><div class="text-muted small"><p> So what is a Storge Gateway? A Storage Gateway it just a way to connect AWS storage in a traditional way e.g. NFS, SMB etc. Lets build one with Terraform A fully working envriment with a Stora...</p></div></div></a></div><div class="card"> <a href="/posts/Expanding-EBS-root-volume/"><div class="card-body"> <em class="small" data-ts="1663423200" data-df="ll" > Sep 17, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Expanding EBS root volume</h3><div class="text-muted small"><p> Expand the root volume. Then, extend the file system using the Amazon EC2 console (new console) From the Amazon EC2 console, choose Instances from the navigation pane. Select the ...</p></div></div></a></div><div class="card"> <a href="/posts/Create-a-systemd-service-to-monitor-Cloudwatch-agent/"><div class="card-body"> <em class="small" data-ts="1666387800" data-df="ll" > Oct 21, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Create a systemd service to monitor Cloudwatch agent</h3><div class="text-muted small"><p> The problem to solve If you are monitoring an AWS instance that is busy and has other programs accessing the same logs as the Cloudwatch agent then you may run into this error in the agents logs “...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/atlas-project-part-one/" class="btn btn-outline-primary" prompt="Older"><p>Atlas Project - part one</p></a><div class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/Harrison-S1">Sam</a>.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/howto-s/">howto's</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/sysops/">sysops</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/cloud/">cloud</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/security/">security</a> <a class="post-tag" href="/tags/ansible/">ansible</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/terraform/">terraform</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-TSY28JSKB0"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-TSY28JSKB0'); }); </script>
