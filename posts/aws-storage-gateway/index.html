<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Creating a Storage Gateway in AWS" /><meta property="og:locale" content="en" /><meta name="description" content="So what is a Storge Gateway? A Storage Gateway it just a way to connect AWS storage in a traditional way e.g. NFS, SMB etc." /><meta property="og:description" content="So what is a Storge Gateway? A Storage Gateway it just a way to connect AWS storage in a traditional way e.g. NFS, SMB etc." /><link rel="canonical" href="/posts/aws-storage-gateway/" /><meta property="og:url" content="/posts/aws-storage-gateway/" /><meta property="og:site_name" content="Samâ€™s 2nd brain" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-12-17T14:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Creating a Storage Gateway in AWS" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-12-20T15:10:30+00:00","datePublished":"2022-12-17T14:00:00+00:00","description":"So what is a Storge Gateway? A Storage Gateway it just a way to connect AWS storage in a traditional way e.g. NFS, SMB etc.","headline":"Creating a Storage Gateway in AWS","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/aws-storage-gateway/"},"url":"/posts/aws-storage-gateway/"}</script><title>Creating a Storage Gateway in AWS | Sam's 2nd brain</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Sam's 2nd brain"><meta name="application-name" content="Sam's 2nd brain"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/54186142?s=400&u=fabf11da8c31b3afad7d8fbc76732b43734a685c&v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Sam's 2nd brain</a></div><div class="site-subtitle font-italic">brain of brain</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/Harrison-S1" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Creating a Storage Gateway in AWS</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Creating a Storage Gateway in AWS</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1671285600" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Dec 17, 2022 </em> </span> <span> Updated <em class="" data-ts="1671549030" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Dec 20, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/username">Sam</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="957 words"> <em>5 min</em> read</span></div></div></div><div class="post-content"><h1 id="so-what-is-a-storge-gateway">So what is a Storge Gateway?</h1><p>A Storage Gateway it just a way to connect AWS storage in a traditional way e.g. NFS, SMB etc.</p><h2 id="lets-build-one-with-terraform"><span class="mr-2">Lets build one with Terraform</span><a href="#lets-build-one-with-terraform" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><blockquote><p>A fully working envriment with a Storage Gateway can be found <a href="https://github.com/Harrison-S1/terraform/tree/master/aws_dev_env_sg">here</a></p></blockquote><p>So a Storage Gateway is built up of the following</p><ul><li>A instance with a dedicated 150GB cahce drive<li>A role<li>A security group<li>S3 bucket (in this example)<li>S3 policy</ul><h2 id="the-instance"><span class="mr-2">The Instance</span><a href="#the-instance" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-terraform highlighter-rouge"><div class="code-header"> <span data-label-text="Terraform"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre><td class="rouge-code"><pre>
<span class="c1">// NOTE: the varable for the instance ami used here will be stored in a datasource.tf file.</span>

  <span class="k">resource</span> <span class="s2">"aws_instance"</span> <span class="s2">"dev_gateway"</span> <span class="p">{</span>
  <span class="nx">instance_type</span>          <span class="p">=</span> <span class="s2">"m5.xlarge"</span>
  <span class="nx">ami</span>                    <span class="p">=</span> <span class="k">data</span><span class="p">.</span><span class="nx">aws_ami</span><span class="p">.</span><span class="nx">server_ami_gw</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">key_name</span>               <span class="p">=</span> <span class="nx">aws_key_pair</span><span class="p">.</span><span class="nx">clouddev_auth</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">vpc_security_group_ids</span> <span class="p">=</span> <span class="p">[</span><span class="nx">aws_security_group</span><span class="p">.</span><span class="nx">main_gateway_sg</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
  <span class="nx">iam_instance_profile</span>   <span class="p">=</span> <span class="nx">aws_iam_instance_profile</span><span class="p">.</span><span class="nx">dev_profile</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">subnet_id</span>              <span class="p">=</span> <span class="nx">aws_subnet</span><span class="p">.</span><span class="nx">main_public_subnet</span><span class="p">.</span><span class="nx">id</span>

  <span class="nx">root_block_device</span> <span class="p">{</span>
    <span class="nx">volume_size</span> <span class="p">=</span> <span class="mi">80</span>
    <span class="nx">volume_type</span> <span class="p">=</span> <span class="s2">"gp3"</span>
  <span class="p">}</span>

  <span class="nx">tags</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="p">=</span> <span class="s2">"dev-gateway"</span>
  <span class="p">}</span>
  <span class="p">}</span>


<span class="c1">// NOTE: This is where you will define the disk used for the cache.</span>

<span class="k">resource</span> <span class="s2">"aws_ebs_volume"</span> <span class="s2">"dev-cache"</span> <span class="p">{</span>
  <span class="nx">availability_zone</span> <span class="p">=</span> <span class="s2">"eu-west-2a"</span>
  <span class="nx">size</span> <span class="p">=</span> <span class="mi">150</span>
  <span class="nx">type</span> <span class="p">=</span> <span class="s2">"gp3"</span>
  <span class="nx">encrypted</span> <span class="p">=</span> <span class="kc">true</span>

  <span class="nx">tags</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="p">=</span> <span class="s2">"dev-cache"</span>
  <span class="p">}</span>
    <span class="nx">depends_on</span> <span class="p">=</span> <span class="p">[</span>
    <span class="nx">aws_instance</span><span class="p">.</span><span class="nx">dev_gateway</span>
  <span class="p">]</span>
<span class="p">}</span>

<span class="c1">// NOTE: This is where you will attck the disk to the new instance. </span>

<span class="k">resource</span> <span class="s2">"aws_volume_attachment"</span> <span class="s2">"ebs_att"</span> <span class="p">{</span>
  <span class="nx">device_name</span> <span class="p">=</span> <span class="s2">"/dev/xvds"</span>
  <span class="nx">volume_id</span>   <span class="p">=</span> <span class="nx">aws_ebs_volume</span><span class="p">.</span><span class="nx">dev</span><span class="err">-</span><span class="nx">cache</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">instance_id</span> <span class="p">=</span> <span class="nx">aws_instance</span><span class="p">.</span><span class="nx">dev_gateway</span><span class="p">.</span><span class="nx">id</span>
<span class="p">}</span>

<span class="k">data</span> <span class="s2">"aws_storagegateway_local_disk"</span> <span class="s2">"example"</span> <span class="p">{</span>
  <span class="nx">disk_node</span>   <span class="p">=</span> <span class="s2">"/dev/xvds"</span>
  <span class="nx">gateway_arn</span> <span class="p">=</span> <span class="nx">aws_storagegateway_gateway</span><span class="p">.</span><span class="nx">g1</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_storagegateway_cache"</span> <span class="s2">"dev-cache"</span> <span class="p">{</span>
  <span class="nx">disk_id</span>     <span class="p">=</span> <span class="k">data</span><span class="p">.</span><span class="nx">aws_storagegateway_local_disk</span><span class="p">.</span><span class="nx">example</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">gateway_arn</span> <span class="p">=</span> <span class="nx">aws_storagegateway_gateway</span><span class="p">.</span><span class="nx">g1</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The varable for the instance ami will look like this:</p><blockquote><p>The ami that is being used has been built by AWS.</p></blockquote><div class="language-terraform highlighter-rouge"><div class="code-header"> <span data-label-text="Terraform"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>
<span class="k">data</span> <span class="s2">"aws_ami"</span> <span class="s2">"server_ami_gw"</span> <span class="p">{</span>
  <span class="nx">most_recent</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">owners</span>      <span class="p">=</span> <span class="p">[</span><span class="s2">"029176880048"</span><span class="p">]</span>

  <span class="nx">filter</span> <span class="p">{</span>
    <span class="nx">name</span>   <span class="p">=</span> <span class="s2">"name"</span>
    <span class="nx">values</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"aws-storage-gateway-*"</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>If you are building this in one .tf file just add the above data source for it run.</p></blockquote><h2 id="security-group"><span class="mr-2">Security Group</span><a href="#security-group" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-terraform highlighter-rouge"><div class="code-header"> <span data-label-text="Terraform"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
</pre><td class="rouge-code"><pre>
<span class="c1">// NOTE: Ingress / Egress rules taken from AWS:</span>
<span class="c1">// https://docs.aws.amazon.com/storagegateway/latest/userguide/Resource_Ports.html</span>
<span class="k">resource</span> <span class="s2">"aws_security_group"</span> <span class="s2">"main_gateway_sg"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="p">=</span> <span class="s2">"dev-gateway"</span>
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"Security Group for NFS File Gateway."</span>
  <span class="nx">vpc_id</span>      <span class="p">=</span> <span class="nx">aws_vpc</span><span class="p">.</span><span class="nx">mainvpc</span><span class="p">.</span><span class="nx">id</span>

  <span class="c1">// Activation</span>

  <span class="nx">ingress</span> <span class="p">{</span>
    <span class="nx">protocol</span>    <span class="p">=</span> <span class="s2">"tcp"</span>
    <span class="nx">from_port</span>   <span class="p">=</span> <span class="mi">80</span>
    <span class="nx">to_port</span>     <span class="p">=</span> <span class="mi">80</span>
    <span class="nx">cidr_blocks</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="nx">ingress</span> <span class="p">{</span>
    <span class="nx">protocol</span>    <span class="p">=</span> <span class="s2">"tcp"</span>
    <span class="nx">from_port</span>   <span class="p">=</span> <span class="mi">443</span>
    <span class="nx">to_port</span>     <span class="p">=</span> <span class="mi">443</span>
    <span class="nx">cidr_blocks</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="c1">// NFS</span>

  <span class="nx">ingress</span> <span class="p">{</span>
    <span class="nx">protocol</span>    <span class="p">=</span> <span class="s2">"tcp"</span>
    <span class="nx">from_port</span>   <span class="p">=</span> <span class="mi">20048</span>
    <span class="nx">to_port</span>     <span class="p">=</span> <span class="mi">20048</span>
    <span class="nx">cidr_blocks</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="nx">ingress</span> <span class="p">{</span>
    <span class="nx">protocol</span>    <span class="p">=</span> <span class="s2">"udp"</span>
    <span class="nx">from_port</span>   <span class="p">=</span> <span class="mi">20048</span>
    <span class="nx">to_port</span>     <span class="p">=</span> <span class="mi">20048</span>
    <span class="nx">cidr_blocks</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="nx">ingress</span> <span class="p">{</span>
    <span class="nx">protocol</span>    <span class="p">=</span> <span class="s2">"tcp"</span>
    <span class="nx">from_port</span>   <span class="p">=</span> <span class="mi">111</span>
    <span class="nx">to_port</span>     <span class="p">=</span> <span class="mi">111</span>
    <span class="nx">cidr_blocks</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="nx">ingress</span> <span class="p">{</span>
    <span class="nx">protocol</span>    <span class="p">=</span> <span class="s2">"udp"</span>
    <span class="nx">from_port</span>   <span class="p">=</span> <span class="mi">111</span>
    <span class="nx">to_port</span>     <span class="p">=</span> <span class="mi">111</span>
    <span class="nx">cidr_blocks</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="nx">ingress</span> <span class="p">{</span>
    <span class="nx">protocol</span>    <span class="p">=</span> <span class="s2">"tcp"</span>
    <span class="nx">from_port</span>   <span class="p">=</span> <span class="mi">2049</span>
    <span class="nx">to_port</span>     <span class="p">=</span> <span class="mi">2049</span>
    <span class="nx">cidr_blocks</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="nx">ingress</span> <span class="p">{</span>
    <span class="nx">protocol</span>    <span class="p">=</span> <span class="s2">"udp"</span>
    <span class="nx">from_port</span>   <span class="p">=</span> <span class="mi">2049</span>
    <span class="nx">to_port</span>     <span class="p">=</span> <span class="mi">2049</span>
    <span class="nx">cidr_blocks</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="c1">// DNS</span>

  <span class="nx">ingress</span> <span class="p">{</span>
    <span class="nx">protocol</span>    <span class="p">=</span> <span class="s2">"tcp"</span>
    <span class="nx">from_port</span>   <span class="p">=</span> <span class="mi">53</span>
    <span class="nx">to_port</span>     <span class="p">=</span> <span class="mi">53</span>
    <span class="nx">cidr_blocks</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="nx">ingress</span> <span class="p">{</span>
    <span class="nx">protocol</span>    <span class="p">=</span> <span class="s2">"udp"</span>
    <span class="nx">from_port</span>   <span class="p">=</span> <span class="mi">53</span>
    <span class="nx">to_port</span>     <span class="p">=</span> <span class="mi">53</span>
    <span class="nx">cidr_blocks</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="c1">// Allow all egress</span>

  <span class="nx">egress</span> <span class="p">{</span>
    <span class="nx">from_port</span>   <span class="p">=</span> <span class="mi">0</span>
    <span class="nx">to_port</span>     <span class="p">=</span> <span class="mi">0</span>
    <span class="nx">protocol</span>    <span class="p">=</span> <span class="s2">"-1"</span>
    <span class="nx">cidr_blocks</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="lets-configure-the-gatewaynfs-share--add-the-s3-policy"><span class="mr-2">Lets configure the gateway,NFS share &amp; add the S3 policy.</span><a href="#lets-configure-the-gatewaynfs-share--add-the-s3-policy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-terraform highlighter-rouge"><div class="code-header"> <span data-label-text="Terraform"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre><td class="rouge-code"><pre><span class="k">resource</span> <span class="s2">"aws_storagegateway_gateway"</span> <span class="s2">"g1"</span> <span class="p">{</span>
  <span class="nx">gateway_name</span>       <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">gateway_name</span>
  <span class="nx">gateway_timezone</span>   <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">gateway_timezone</span>
  <span class="nx">gateway_type</span>       <span class="p">=</span> <span class="s2">"FILE_S3"</span>
  <span class="nx">gateway_ip_address</span> <span class="p">=</span> <span class="nx">aws_instance</span><span class="p">.</span><span class="nx">dev_gateway</span><span class="p">.</span><span class="nx">public_ip</span>

  <span class="nx">depends_on</span> <span class="p">=</span> <span class="p">[</span>
    <span class="nx">aws_instance</span><span class="p">.</span><span class="nx">dev_gateway</span>
  <span class="p">]</span>

<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_storagegateway_nfs_file_share"</span> <span class="s2">"file_share"</span> <span class="p">{</span>
  <span class="nx">client_list</span>  <span class="p">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
  <span class="nx">gateway_arn</span>  <span class="p">=</span> <span class="nx">aws_storagegateway_gateway</span><span class="p">.</span><span class="nx">g1</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">location_arn</span> <span class="p">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">gate_buc</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">role_arn</span>     <span class="p">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">role</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_iam_policy"</span> <span class="s2">"policy"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="p">=</span> <span class="s2">"S3_policy"</span>
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"Providing limited S3 powers"</span>

  <span class="c1"># Terraform's "jsonencode" function converts a</span>
  <span class="c1"># Terraform expression result to valid JSON syntax.</span>
  <span class="nx">policy</span> <span class="p">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
      <span class="s2">"Version"</span><span class="err">:</span> <span class="s2">"2012-10-17"</span><span class="p">,</span>
    <span class="s2">"Statement"</span><span class="err">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">"Action"</span><span class="err">:</span> <span class="p">[</span>
                <span class="s2">"s3:GetAccelerateConfiguration"</span><span class="p">,</span>
                <span class="s2">"s3:GetBucketLocation"</span><span class="p">,</span>
                <span class="s2">"s3:GetBucketVersioning"</span><span class="p">,</span>
                <span class="s2">"s3:ListBucket"</span><span class="p">,</span>
                <span class="s2">"s3:ListBucketVersions"</span><span class="p">,</span>
                <span class="s2">"s3:ListBucketMultipartUploads"</span>
            <span class="p">],</span>
            <span class="s2">"Resource"</span><span class="err">:</span> <span class="s2">"arn:aws:s3:::</span><span class="k">${</span><span class="kd">var</span><span class="p">.</span><span class="nx">bucket_name</span><span class="k">}</span><span class="s2">"</span><span class="p">,</span>
            <span class="s2">"Effect"</span><span class="err">:</span> <span class="s2">"Allow"</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">"Action"</span><span class="err">:</span> <span class="p">[</span>
                <span class="s2">"s3:AbortMultipartUpload"</span><span class="p">,</span>
                <span class="s2">"s3:DeleteObject"</span><span class="p">,</span>
                <span class="s2">"s3:DeleteObjectVersion"</span><span class="p">,</span>
                <span class="s2">"s3:GetObject"</span><span class="p">,</span>
                <span class="s2">"s3:GetObjectAcl"</span><span class="p">,</span>
                <span class="s2">"s3:GetObjectVersion"</span><span class="p">,</span>
                <span class="s2">"s3:ListMultipartUploadParts"</span><span class="p">,</span>
                <span class="s2">"s3:PutObject"</span><span class="p">,</span>
                <span class="s2">"s3:PutObjectAcl"</span>
            <span class="p">],</span>
            <span class="s2">"Resource"</span><span class="err">:</span> <span class="s2">"arn:aws:s3:::</span><span class="k">${</span><span class="kd">var</span><span class="p">.</span><span class="nx">bucket_name</span><span class="k">}</span><span class="s2">/*"</span><span class="p">,</span>
            <span class="s2">"Effect"</span><span class="err">:</span> <span class="s2">"Allow"</span>
        <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">})</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="finally-lets-create-our-s3-butcket"><span class="mr-2">Finally lets create our S3 butcket</span><a href="#finally-lets-create-our-s3-butcket" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-terraform highlighter-rouge"><div class="code-header"> <span data-label-text="Terraform"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">resource</span> <span class="s2">"aws_s3_bucket"</span> <span class="s2">"gate_buc"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">bucket_name</span>

  <span class="nx">tags</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">Name</span>        <span class="p">=</span> <span class="s2">"My bucket"</span>
    <span class="nx">Environment</span> <span class="p">=</span> <span class="s2">"Dev"</span>
  <span class="p">}</span>
</pre></table></code></div></div><p>And thatâ€™s it, run your <code class="language-plaintext highlighter-rouge">terraform apply</code>. You should now have a storage gaetway instance in your EC2 console and your share will be available from the Storage Gateway console with the command you need to mount it. Make sure you read the AWS <a href="https://docs.aws.amazon.com/storagegateway/index.html">Docs</a> and the Terraform <a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/storagegateway_gateway">Docs</a></p><h2 id="is-this-the-best-way-to-access-cloud-storage"><span class="mr-2">Is this the best way to access cloud storage?</span><a href="#is-this-the-best-way-to-access-cloud-storage" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>No, I donâ€™t think it is for the following reasons:</p><ul><li>This solution will be charging you for the instance, ebs volume, S3 bucket and the pulic IP etc.<li>There is a easier way to mount cloud storage on prem and within the cloud environmentâ€¦â€¦<a href="https://rclone.org/">Rclone</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/aws/'>aws</a>, <a href='/categories/howto-s/'>howto's</a>, <a href='/categories/linux/'>linux</a>, <a href='/categories/cloud/'>cloud</a>, <a href='/categories/terraform/'>terraform</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/aws/" class="post-tag no-text-decoration" >aws</a> <a href="/tags/linux/" class="post-tag no-text-decoration" >linux</a> <a href="/tags/howto-s/" class="post-tag no-text-decoration" >howto's</a> <a href="/tags/sysops/" class="post-tag no-text-decoration" >sysops</a> <a href="/tags/cloud/" class="post-tag no-text-decoration" >cloud</a> <a href="/tags/terraform/" class="post-tag no-text-decoration" >terraform</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Creating+a+Storage+Gateway+in+AWS+-+Sam%27s+2nd+brain&url=%2Fposts%2Faws-storage-gateway%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Creating+a+Storage+Gateway+in+AWS+-+Sam%27s+2nd+brain&u=%2Fposts%2Faws-storage-gateway%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Faws-storage-gateway%2F&text=Creating+a+Storage+Gateway+in+AWS+-+Sam%27s+2nd+brain" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=%2Fposts%2Faws-storage-gateway%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/atlas-project-part-two/">Atlas project - part two</a><li><a href="/posts/atlas-project-part-one/">Atlas Project - part one</a><li><a href="/posts/aws-storage-gateway/">Creating a Storage Gateway in AWS</a><li><a href="/posts/Expanding-EBS-root-volume/">Expanding EBS root volume</a><li><a href="/posts/CloudWatch-Monitor-EC2-Linux-services-and-set-alarms/">CloudWatch Monitor EC2 Linux services and set alarms</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/howto-s/">howto's</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/sysops/">sysops</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/cloud/">cloud</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/security/">security</a> <a class="post-tag" href="/tags/ansible/">ansible</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/terraform/">terraform</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/atlas-project-part-one/"><div class="card-body"> <em class="small" data-ts="1681740000" data-df="ll" > Apr 17, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Atlas Project - part one</h3><div class="text-muted small"><p> Often in tech it is hard to see the wood through the trees and stringing what you know and learned together can be difficult. So here is my mini project to learn more about GitHub actions Terraform...</p></div></div></a></div><div class="card"> <a href="/posts/atlas-project-part-two/"><div class="card-body"> <em class="small" data-ts="1682344800" data-df="ll" > Apr 24, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Atlas project - part two</h3><div class="text-muted small"><p> OK, so we have our docker image, and we are storing it in the Docker repository. Now what. Well we want to create some cloud infrastructure, so we can deploy our game, but we will be using Terrafor...</p></div></div></a></div><div class="card"> <a href="/posts/Expanding-EBS-root-volume/"><div class="card-body"> <em class="small" data-ts="1663423200" data-df="ll" > Sep 17, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Expanding EBS root volume</h3><div class="text-muted small"><p> Expand the root volume. Then, extend the file system using the Amazon EC2 console (new console) From the Amazon EC2 console, choose Instances from the navigation pane. Select the ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/CloudWatch-Monitor-EC2-Linux-services-and-set-alarms/" class="btn btn-outline-primary" prompt="Older"><p>CloudWatch Monitor EC2 Linux services and set alarms</p></a> <a href="/posts/atlas-project-part-one/" class="btn btn-outline-primary" prompt="Newer"><p>Atlas Project - part one</p></a></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> Â© 2023 <a href="https://github.com/Harrison-S1">Sam</a>.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/howto-s/">howto's</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/sysops/">sysops</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/cloud/">cloud</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/security/">security</a> <a class="post-tag" href="/tags/ansible/">ansible</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/terraform/">terraform</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-TSY28JSKB0"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-TSY28JSKB0'); }); </script>
